<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>3.7 Inverse Probability Weighting (IPW) | IPW and AIPW</title>
  <meta name="description" content="3.7 Inverse Probability Weighting (IPW) | IPW and AIPW" />
  <meta name="generator" content="bookdown 0.39 and GitBook 2.6.7" />

  <meta property="og:title" content="3.7 Inverse Probability Weighting (IPW) | IPW and AIPW" />
  <meta property="og:type" content="book" />
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="3.7 Inverse Probability Weighting (IPW) | IPW and AIPW" />
  
  
  

<meta name="author" content="Vinish Shrestha" />


<meta name="date" content="2025-01-08" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="propensity-score-stratification.html"/>
<link rel="next" href="comparing-ipw-with-aggregated-estimate.html"/>
<script src="assets/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="assets/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="assets/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="assets/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="assets/anchor-sections-1.1.0/anchor-sections.js"></script>
<script src="assets/kePrint-0.0.1/kePrint.js"></script>
<link href="assets/lightable-0.0.1/lightable.css" rel="stylesheet" />


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>
<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Work in Progress</a></li>
<li class="chapter" data-level="2" data-path="causal-inference-an-introduction.html"><a href="causal-inference-an-introduction.html"><i class="fa fa-check"></i><b>2</b> Causal Inference: An Introduction</a>
<ul>
<li class="chapter" data-level="2.1" data-path="potential-outcome-framework-neyman-rubin-causal-model.html"><a href="potential-outcome-framework-neyman-rubin-causal-model.html"><i class="fa fa-check"></i><b>2.1</b> Potential Outcome Framework: Neyman-Rubin Causal Model</a></li>
<li class="chapter" data-level="2.2" data-path="average-treatment-effect-ate.html"><a href="average-treatment-effect-ate.html"><i class="fa fa-check"></i><b>2.2</b> Average treatment effect (ATE)</a></li>
<li class="chapter" data-level="2.3" data-path="rct.html"><a href="rct.html"><i class="fa fa-check"></i><b>2.3</b> RCT</a></li>
<li class="chapter" data-level="2.4" data-path="average-treatment-effect-on-the-treated-att.html"><a href="average-treatment-effect-on-the-treated-att.html"><i class="fa fa-check"></i><b>2.4</b> Average treatment effect on the treated (ATT)</a></li>
<li class="chapter" data-level="2.5" data-path="an-estimation-example.html"><a href="an-estimation-example.html"><i class="fa fa-check"></i><b>2.5</b> An estimation example</a></li>
<li class="chapter" data-level="2.6" data-path="unconfoundedness-assumption.html"><a href="unconfoundedness-assumption.html"><i class="fa fa-check"></i><b>2.6</b> Unconfoundedness assumption</a></li>
<li class="chapter" data-level="2.7" data-path="discussion.html"><a href="discussion.html"><i class="fa fa-check"></i><b>2.7</b> Discussion</a></li>
<li class="chapter" data-level="2.8" data-path="reference.html"><a href="reference.html"><i class="fa fa-check"></i><b>2.8</b> Reference</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="ipw-and-aipw.html"><a href="ipw-and-aipw.html"><i class="fa fa-check"></i><b>3</b> IPW and AIPW</a>
<ul>
<li class="chapter" data-level="3.1" data-path="a-simple-example.html"><a href="a-simple-example.html"><i class="fa fa-check"></i><b>3.1</b> A simple example</a></li>
<li class="chapter" data-level="3.2" data-path="aggregated-estimator.html"><a href="aggregated-estimator.html"><i class="fa fa-check"></i><b>3.2</b> Aggregated Estimator</a></li>
<li class="chapter" data-level="3.3" data-path="propensity-score.html"><a href="propensity-score.html"><i class="fa fa-check"></i><b>3.3</b> Propensity score</a></li>
<li class="chapter" data-level="3.4" data-path="estimation-of-propensity-score.html"><a href="estimation-of-propensity-score.html"><i class="fa fa-check"></i><b>3.4</b> Estimation of propensity score</a></li>
<li class="chapter" data-level="3.5" data-path="using-cross-fitting-to-predict-propensity-score.html"><a href="using-cross-fitting-to-predict-propensity-score.html"><i class="fa fa-check"></i><b>3.5</b> Using cross-fitting to predict propensity score</a></li>
<li class="chapter" data-level="3.6" data-path="propensity-score-stratification.html"><a href="propensity-score-stratification.html"><i class="fa fa-check"></i><b>3.6</b> Propensity score stratification</a></li>
<li class="chapter" data-level="3.7" data-path="inverse-probability-weighting-ipw.html"><a href="inverse-probability-weighting-ipw.html"><i class="fa fa-check"></i><b>3.7</b> Inverse Probability Weighting (IPW)</a></li>
<li class="chapter" data-level="3.8" data-path="comparing-ipw-with-aggregated-estimate.html"><a href="comparing-ipw-with-aggregated-estimate.html"><i class="fa fa-check"></i><b>3.8</b> Comparing IPW with Aggregated Estimate</a></li>
<li class="chapter" data-level="3.9" data-path="aipw-and-estimation.html"><a href="aipw-and-estimation.html"><i class="fa fa-check"></i><b>3.9</b> AIPW and Estimation</a></li>
<li class="chapter" data-level="3.10" data-path="assessing-balance.html"><a href="assessing-balance.html"><i class="fa fa-check"></i><b>3.10</b> Assessing Balance</a></li>
<li class="chapter" data-level="3.11" data-path="cross-fitting.html"><a href="cross-fitting.html"><i class="fa fa-check"></i><b>3.11</b> Cross-fitting</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="causal-forest.html"><a href="causal-forest.html"><i class="fa fa-check"></i><b>4</b> Causal Forest</a>
<ul>
<li class="chapter" data-level="4.1" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>4.1</b> Introduction</a></li>
<li class="chapter" data-level="4.2" data-path="summary-of-grf.html"><a href="summary-of-grf.html"><i class="fa fa-check"></i><b>4.2</b> Summary of GRF</a></li>
<li class="chapter" data-level="4.3" data-path="motivation-for-causal-forests.html"><a href="motivation-for-causal-forests.html"><i class="fa fa-check"></i><b>4.3</b> Motivation for Causal Forests</a></li>
<li class="chapter" data-level="4.4" data-path="causal-forest-1.html"><a href="causal-forest-1.html"><i class="fa fa-check"></i><b>4.4</b> Causal Forest</a></li>
<li class="chapter" data-level="4.5" data-path="an-example-of-causal-forest.html"><a href="an-example-of-causal-forest.html"><i class="fa fa-check"></i><b>4.5</b> An example of causal forest</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="heterogeneous-treatment-effects.html"><a href="heterogeneous-treatment-effects.html"><i class="fa fa-check"></i><b>5</b> Heterogeneous Treatment Effects</a>
<ul>
<li class="chapter" data-level="5.1" data-path="some-ways-to-estimate-cate.html"><a href="some-ways-to-estimate-cate.html"><i class="fa fa-check"></i><b>5.1</b> Some ways to estimate CATE</a></li>
<li class="chapter" data-level="5.2" data-path="estimation.html"><a href="estimation.html"><i class="fa fa-check"></i><b>5.2</b> Estimation</a></li>
<li class="chapter" data-level="5.3" data-path="some-remarks-and-questions.html"><a href="some-remarks-and-questions.html"><i class="fa fa-check"></i><b>5.3</b> Some Remarks and Questions</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">IPW and AIPW</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="inverse-probability-weighting-ipw" class="section level2 hasAnchor" number="3.7">
<h2><span class="header-section-number">3.7</span> Inverse Probability Weighting (IPW)<a href="inverse-probability-weighting-ipw.html#inverse-probability-weighting-ipw" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>A more natural way to exploit the condition of unconfoundedness is to weight observations by their propensity score, which is known as the inverse probability weighting. As before <span class="math inline">\(\hat{e}(x)\)</span> is defined as an estimated propensity score.</p>
<p><span class="math display" id="eq:IPW">\[\begin{equation}
\hat{\tau}_{IPW} = \frac{1}{N}\sum_{i = 1}^{N} \Bigg(\frac{Y_i . W_i}{\hat{e}(X_i)} - \frac{Y_i . (1-W_i)}{1 - \hat{e}(X_i)}\Bigg) \tag{3.10}
\end{equation}\]</span></p>
<p>Intuitively, observations with high propensity score within the treated group are weighted down, while observations with higher propensity score in the control group are weighted more. In this way, propensity score is used to balance the differences in covariates across the treatment and control groups. Note that the validity of <span class="math inline">\(\hat{\tau}\)</span> still hinges on the unconfoundedness assumption. Any inference that you make is only good if your assumption holds.</p>
<p><strong>Limitation of IPW Estimate.</strong> One way to analyze the accuracy of <span class="math inline">\(\hat{\tau}_{IPW}\)</span> is to compare it with the oracle IPW estimate, <span class="math inline">\(\hat{\tau}_{IPW}^{*}\)</span>. The oracle estimate is obtained from the known propensity score. Briefly, comparison between <span class="math inline">\(\hat{\tau}_{IPW}^{*}\)</span> and <span class="math inline">\(\hat{\tau}_{AGG}\)</span> suggests that the oracle IPW under-performs <span class="math inline">\(\hat{\tau}_{AGG}\)</span>. In other words, the variance of the oracle estimate is larger than that of <span class="math inline">\(\hat{\tau}_{AGG}\)</span>.</p>
<p>Algorithmically, we can form <em>score</em> as:</p>
<p><span class="math inline">\((\frac{Y_i \times W_i}{\hat{e}(X_i)} - \frac{Y_i \times (1-W_i)}{1 - \hat{e}(X_i)})\)</span></p>
<p>The mean of it results to <span class="math inline">\(\hat{\tau}\)</span> and the standard error of the estimate is simply <span class="math inline">\(\frac{\hat{\sigma}_{score}}{\sqrt{N}}\)</span>.</p>
<p><strong>Estimating IPW.</strong> In the example below we will simulate a dataset where the treatment assignment is made to be correlated with the outcome. This means that the independence assumption does not hold. However, since this is a simulated data, we know exactly what covariates influence the treatment assignment. Hence, we can invoke the unconfoundedness assumption. We estimate the propensity score using random forest based on <em>honest splitting</em>. For this, we use GRF package from .</p>
<p>Note that <span class="math inline">\(e(x)\)</span> is estimated via cross-fitting.</p>
<ol style="list-style-type: decimal">
<li><p>The data is divided into <span class="math inline">\(K\)</span>-folds.</p></li>
<li><p>For each fold <span class="math inline">\(k\)</span>, model building is administered using <span class="math inline">\(-k\)</span> folds.</p></li>
<li><p>Using Step 2, predictions are generated for units in the <span class="math inline">\(k^{th}\)</span> fold.</p></li>
<li><p>Steps 2 and 3 are repeated until all <span class="math inline">\(K\)</span> folds are exhausted.</p></li>
</ol>
<p><strong>Estimation</strong></p>
<p>The following example uses 10 fold cross-fitting.</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb68-1"><a href="inverse-probability-weighting-ipw.html#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="do">#################################</span></span>
<span id="cb68-2"><a href="inverse-probability-weighting-ipw.html#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Author: VS</span></span>
<span id="cb68-3"><a href="inverse-probability-weighting-ipw.html#cb68-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Last Revised: Jan 16, 2024</span></span>
<span id="cb68-4"><a href="inverse-probability-weighting-ipw.html#cb68-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Keywords: IPW, AIPW, GRF</span></span>
<span id="cb68-5"><a href="inverse-probability-weighting-ipw.html#cb68-5" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb68-6"><a href="inverse-probability-weighting-ipw.html#cb68-6" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb68-7"><a href="inverse-probability-weighting-ipw.html#cb68-7" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb68-8"><a href="inverse-probability-weighting-ipw.html#cb68-8" aria-hidden="true" tabindex="-1"></a><span class="do">#################################</span></span>
<span id="cb68-9"><a href="inverse-probability-weighting-ipw.html#cb68-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-10"><a href="inverse-probability-weighting-ipw.html#cb68-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-11"><a href="inverse-probability-weighting-ipw.html#cb68-11" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">194</span>)</span>
<span id="cb68-12"><a href="inverse-probability-weighting-ipw.html#cb68-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-13"><a href="inverse-probability-weighting-ipw.html#cb68-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate Data </span></span>
<span id="cb68-14"><a href="inverse-probability-weighting-ipw.html#cb68-14" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">2000</span></span>
<span id="cb68-15"><a href="inverse-probability-weighting-ipw.html#cb68-15" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb68-16"><a href="inverse-probability-weighting-ipw.html#cb68-16" aria-hidden="true" tabindex="-1"></a>true_effect  <span class="ot">&lt;-</span>  <span class="dv">15</span></span>
<span id="cb68-17"><a href="inverse-probability-weighting-ipw.html#cb68-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-18"><a href="inverse-probability-weighting-ipw.html#cb68-18" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(n <span class="sc">*</span> p), n, p)</span>
<span id="cb68-19"><a href="inverse-probability-weighting-ipw.html#cb68-19" aria-hidden="true" tabindex="-1"></a>X.test <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="dv">101</span>, p)</span>
<span id="cb68-20"><a href="inverse-probability-weighting-ipw.html#cb68-20" aria-hidden="true" tabindex="-1"></a>X.test[, <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">2</span>, <span class="dv">2</span>, <span class="at">length.out =</span> <span class="dv">101</span>)</span>
<span id="cb68-21"><a href="inverse-probability-weighting-ipw.html#cb68-21" aria-hidden="true" tabindex="-1"></a>prob  <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span> (X[, <span class="dv">1</span>] <span class="sc">&gt;</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fu">rnorm</span>(n))))</span>
<span id="cb68-22"><a href="inverse-probability-weighting-ipw.html#cb68-22" aria-hidden="true" tabindex="-1"></a>W <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, prob)</span>
<span id="cb68-23"><a href="inverse-probability-weighting-ipw.html#cb68-23" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> <span class="dv">60</span> <span class="sc">+</span> true_effect <span class="sc">*</span> W <span class="sc">+</span> <span class="dv">5</span> <span class="sc">*</span> <span class="fu">pmax</span>(X[, <span class="dv">1</span>], <span class="dv">0</span>) <span class="sc">+</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb68-24"><a href="inverse-probability-weighting-ipw.html#cb68-24" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(X[, <span class="dv">1</span>], X[, <span class="dv">2</span>], <span class="at">col =</span> <span class="fu">as.factor</span>(W))</span></code></pre></div>
<p><img src="book_files/figure-html/unnamed-chunk-15-1.png" width="672" /></p>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb69-1"><a href="inverse-probability-weighting-ipw.html#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="co">#paste0(&quot;average treatment effect is: &quot;, round(mean(pmax(X[, 1], 0)), 3))</span></span>
<span id="cb69-2"><a href="inverse-probability-weighting-ipw.html#cb69-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-3"><a href="inverse-probability-weighting-ipw.html#cb69-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-4"><a href="inverse-probability-weighting-ipw.html#cb69-4" aria-hidden="true" tabindex="-1"></a><span class="do">#################################</span></span>
<span id="cb69-5"><a href="inverse-probability-weighting-ipw.html#cb69-5" aria-hidden="true" tabindex="-1"></a><span class="do">#################################</span></span>
<span id="cb69-6"><a href="inverse-probability-weighting-ipw.html#cb69-6" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb69-7"><a href="inverse-probability-weighting-ipw.html#cb69-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Inverse Probability Weighting</span></span>
<span id="cb69-8"><a href="inverse-probability-weighting-ipw.html#cb69-8" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb69-9"><a href="inverse-probability-weighting-ipw.html#cb69-9" aria-hidden="true" tabindex="-1"></a><span class="do">#################################</span></span>
<span id="cb69-10"><a href="inverse-probability-weighting-ipw.html#cb69-10" aria-hidden="true" tabindex="-1"></a><span class="do">#################################</span></span>
<span id="cb69-11"><a href="inverse-probability-weighting-ipw.html#cb69-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-12"><a href="inverse-probability-weighting-ipw.html#cb69-12" aria-hidden="true" tabindex="-1"></a><span class="co"># use the random forest to get the propensity score </span></span>
<span id="cb69-13"><a href="inverse-probability-weighting-ipw.html#cb69-13" aria-hidden="true" tabindex="-1"></a>dat  <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(W, X, Y)</span>
<span id="cb69-14"><a href="inverse-probability-weighting-ipw.html#cb69-14" aria-hidden="true" tabindex="-1"></a>n_features  <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">setdiff</span>(<span class="fu">names</span>(dat), <span class="st">&quot;W&quot;</span>))</span>
<span id="cb69-15"><a href="inverse-probability-weighting-ipw.html#cb69-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-16"><a href="inverse-probability-weighting-ipw.html#cb69-16" aria-hidden="true" tabindex="-1"></a><span class="co"># A. ranger (probability tree)</span></span>
<span id="cb69-17"><a href="inverse-probability-weighting-ipw.html#cb69-17" aria-hidden="true" tabindex="-1"></a>rf1_ranger  <span class="ot">&lt;-</span> <span class="fu">ranger</span>(</span>
<span id="cb69-18"><a href="inverse-probability-weighting-ipw.html#cb69-18" aria-hidden="true" tabindex="-1"></a>    W <span class="sc">~</span> ., </span>
<span id="cb69-19"><a href="inverse-probability-weighting-ipw.html#cb69-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> dat, </span>
<span id="cb69-20"><a href="inverse-probability-weighting-ipw.html#cb69-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">mtry =</span> <span class="fu">min</span>(<span class="fu">ceiling</span>(<span class="fu">sqrt</span>(n_features) <span class="sc">+</span> <span class="dv">20</span>), n_features),  </span>
<span id="cb69-21"><a href="inverse-probability-weighting-ipw.html#cb69-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">num.trees =</span> <span class="dv">2000</span>, </span>
<span id="cb69-22"><a href="inverse-probability-weighting-ipw.html#cb69-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">probability =</span>  <span class="cn">TRUE</span></span>
<span id="cb69-23"><a href="inverse-probability-weighting-ipw.html#cb69-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb69-24"><a href="inverse-probability-weighting-ipw.html#cb69-24" aria-hidden="true" tabindex="-1"></a><span class="co"># OOB predictions from ranger</span></span>
<span id="cb69-25"><a href="inverse-probability-weighting-ipw.html#cb69-25" aria-hidden="true" tabindex="-1"></a>p.ranger  <span class="ot">&lt;-</span> rf1_ranger<span class="sc">$</span>predictions[, <span class="dv">1</span>]  </span>
<span id="cb69-26"><a href="inverse-probability-weighting-ipw.html#cb69-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-27"><a href="inverse-probability-weighting-ipw.html#cb69-27" aria-hidden="true" tabindex="-1"></a><span class="co"># B. probability tree using GRF</span></span>
<span id="cb69-28"><a href="inverse-probability-weighting-ipw.html#cb69-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-29"><a href="inverse-probability-weighting-ipw.html#cb69-29" aria-hidden="true" tabindex="-1"></a><span class="co"># cross-fitting index </span></span>
<span id="cb69-30"><a href="inverse-probability-weighting-ipw.html#cb69-30" aria-hidden="true" tabindex="-1"></a>K  <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb69-31"><a href="inverse-probability-weighting-ipw.html#cb69-31" aria-hidden="true" tabindex="-1"></a>ind  <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(W), <span class="at">replace =</span> <span class="cn">FALSE</span>, <span class="at">size =</span> <span class="fu">length</span>(W))</span>
<span id="cb69-32"><a href="inverse-probability-weighting-ipw.html#cb69-32" aria-hidden="true" tabindex="-1"></a>folds  <span class="ot">&lt;-</span> <span class="fu">cut</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(W), <span class="at">breaks =</span> K, <span class="at">labels =</span> <span class="cn">FALSE</span>)</span>
<span id="cb69-33"><a href="inverse-probability-weighting-ipw.html#cb69-33" aria-hidden="true" tabindex="-1"></a>index  <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> <span class="fu">length</span>(ind) <span class="sc">/</span> K, <span class="at">ncol =</span> K)</span>
<span id="cb69-34"><a href="inverse-probability-weighting-ipw.html#cb69-34" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(f <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>K){</span>
<span id="cb69-35"><a href="inverse-probability-weighting-ipw.html#cb69-35" aria-hidden="true" tabindex="-1"></a>    index[, f]  <span class="ot">&lt;-</span> ind[<span class="fu">which</span>(folds <span class="sc">==</span> f)]</span>
<span id="cb69-36"><a href="inverse-probability-weighting-ipw.html#cb69-36" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb69-37"><a href="inverse-probability-weighting-ipw.html#cb69-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-38"><a href="inverse-probability-weighting-ipw.html#cb69-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Build RF using GRF P(W = 1 | X)</span></span>
<span id="cb69-39"><a href="inverse-probability-weighting-ipw.html#cb69-39" aria-hidden="true" tabindex="-1"></a>fun.rf.grf  <span class="ot">&lt;-</span> <span class="cf">function</span>(X, W, predictkfold){</span>
<span id="cb69-40"><a href="inverse-probability-weighting-ipw.html#cb69-40" aria-hidden="true" tabindex="-1"></a>    rf_grf  <span class="ot">&lt;-</span> <span class="fu">regression_forest</span>(X, W, <span class="at">tune.parameters =</span> <span class="st">&quot;all&quot;</span>)</span>
<span id="cb69-41"><a href="inverse-probability-weighting-ipw.html#cb69-41" aria-hidden="true" tabindex="-1"></a>    p.grf  <span class="ot">&lt;-</span> <span class="fu">predict</span>(rf_grf, predictkfold)<span class="sc">$</span>predictions</span>
<span id="cb69-42"><a href="inverse-probability-weighting-ipw.html#cb69-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(p.grf)</span>
<span id="cb69-43"><a href="inverse-probability-weighting-ipw.html#cb69-43" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb69-44"><a href="inverse-probability-weighting-ipw.html#cb69-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-45"><a href="inverse-probability-weighting-ipw.html#cb69-45" aria-hidden="true" tabindex="-1"></a><span class="co"># storing </span></span>
<span id="cb69-46"><a href="inverse-probability-weighting-ipw.html#cb69-46" aria-hidden="true" tabindex="-1"></a>predict.mat  <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> <span class="fu">nrow</span>(index), <span class="at">ncol =</span> K)</span>
<span id="cb69-47"><a href="inverse-probability-weighting-ipw.html#cb69-47" aria-hidden="true" tabindex="-1"></a>tauk  <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, K)</span>
<span id="cb69-48"><a href="inverse-probability-weighting-ipw.html#cb69-48" aria-hidden="true" tabindex="-1"></a>tauk_oracle  <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, K)</span>
<span id="cb69-49"><a href="inverse-probability-weighting-ipw.html#cb69-49" aria-hidden="true" tabindex="-1"></a>weighttau  <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, K)</span>
<span id="cb69-50"><a href="inverse-probability-weighting-ipw.html#cb69-50" aria-hidden="true" tabindex="-1"></a>score  <span class="ot">&lt;-</span>  <span class="fu">list</span>()</span>
<span id="cb69-51"><a href="inverse-probability-weighting-ipw.html#cb69-51" aria-hidden="true" tabindex="-1"></a>score_oracle  <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb69-52"><a href="inverse-probability-weighting-ipw.html#cb69-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-53"><a href="inverse-probability-weighting-ipw.html#cb69-53" aria-hidden="true" tabindex="-1"></a><span class="co"># for each fold i use other folds for estimation </span></span>
<span id="cb69-54"><a href="inverse-probability-weighting-ipw.html#cb69-54" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">seq</span>(<span class="dv">1</span><span class="sc">:</span>K)){</span>
<span id="cb69-55"><a href="inverse-probability-weighting-ipw.html#cb69-55" aria-hidden="true" tabindex="-1"></a>    predict.mat[, i]  <span class="ot">&lt;-</span> <span class="fu">fun.rf.grf</span>(<span class="at">X =</span> X[<span class="fu">c</span>(index[, <span class="sc">-</span>i]), ], <span class="at">W =</span> W[index[, <span class="sc">-</span>i]], <span class="at">predictkfold =</span> X[<span class="fu">c</span>(index[, i]), ])</span>
<span id="cb69-56"><a href="inverse-probability-weighting-ipw.html#cb69-56" aria-hidden="true" tabindex="-1"></a>    <span class="co"># fold-specific treatment effect</span></span>
<span id="cb69-57"><a href="inverse-probability-weighting-ipw.html#cb69-57" aria-hidden="true" tabindex="-1"></a>    score[[i]]  <span class="ot">&lt;-</span> ((W[index[, i]] <span class="sc">*</span> Y[index[, i]]) <span class="sc">/</span> (predict.mat[, i])) <span class="sc">-</span> </span>
<span id="cb69-58"><a href="inverse-probability-weighting-ipw.html#cb69-58" aria-hidden="true" tabindex="-1"></a>                (((<span class="dv">1</span> <span class="sc">-</span> W[index[, i]]) <span class="sc">*</span> Y[index[, i]]) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> predict.mat[, i]))</span>
<span id="cb69-59"><a href="inverse-probability-weighting-ipw.html#cb69-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-60"><a href="inverse-probability-weighting-ipw.html#cb69-60" aria-hidden="true" tabindex="-1"></a>    tauk[i]  <span class="ot">&lt;-</span> <span class="fu">mean</span>(score[[i]])</span>
<span id="cb69-61"><a href="inverse-probability-weighting-ipw.html#cb69-61" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb69-62"><a href="inverse-probability-weighting-ipw.html#cb69-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-63"><a href="inverse-probability-weighting-ipw.html#cb69-63" aria-hidden="true" tabindex="-1"></a><span class="co"># ipw using oracle propensity score and propensity score estimated from grf </span></span>
<span id="cb69-64"><a href="inverse-probability-weighting-ipw.html#cb69-64" aria-hidden="true" tabindex="-1"></a>alpha  <span class="ot">&lt;-</span>  <span class="fl">0.05</span> <span class="co"># 5 percent level of significance</span></span>
<span id="cb69-65"><a href="inverse-probability-weighting-ipw.html#cb69-65" aria-hidden="true" tabindex="-1"></a><span class="co">#ipw.ranger  &lt;- mean(((W * Y) / (p.ranger)) - (((1 - W) * Y) / (1 - p.ranger))) </span></span>
<span id="cb69-66"><a href="inverse-probability-weighting-ipw.html#cb69-66" aria-hidden="true" tabindex="-1"></a>ipw.grf  <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">unlist</span>(score))</span>
<span id="cb69-67"><a href="inverse-probability-weighting-ipw.html#cb69-67" aria-hidden="true" tabindex="-1"></a>score_oracle  <span class="ot">&lt;-</span> ((W <span class="sc">*</span> Y) <span class="sc">/</span> (prob)) <span class="sc">-</span> </span>
<span id="cb69-68"><a href="inverse-probability-weighting-ipw.html#cb69-68" aria-hidden="true" tabindex="-1"></a>                ((<span class="dv">1</span> <span class="sc">-</span> W) <span class="sc">*</span> Y <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> prob))</span>
<span id="cb69-69"><a href="inverse-probability-weighting-ipw.html#cb69-69" aria-hidden="true" tabindex="-1"></a>ipw.oracle  <span class="ot">&lt;-</span> <span class="fu">mean</span>(score_oracle)</span>
<span id="cb69-70"><a href="inverse-probability-weighting-ipw.html#cb69-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-71"><a href="inverse-probability-weighting-ipw.html#cb69-71" aria-hidden="true" tabindex="-1"></a>sd.ipw  <span class="ot">&lt;-</span>  <span class="fu">sd</span>(<span class="fu">unlist</span>(score))</span>
<span id="cb69-72"><a href="inverse-probability-weighting-ipw.html#cb69-72" aria-hidden="true" tabindex="-1"></a>sd.oracle  <span class="ot">&lt;-</span>  <span class="fu">sd</span>(score_oracle)</span>
<span id="cb69-73"><a href="inverse-probability-weighting-ipw.html#cb69-73" aria-hidden="true" tabindex="-1"></a>ll  <span class="ot">&lt;-</span> ipw.grf <span class="sc">-</span> (sd.ipw <span class="sc">/</span> <span class="fu">sqrt</span>(<span class="fu">length</span>(<span class="fu">unlist</span>(score)))) <span class="sc">*</span> <span class="fu">qnorm</span>(<span class="dv">1</span> <span class="sc">-</span> alpha<span class="sc">/</span><span class="dv">2</span>)</span>
<span id="cb69-74"><a href="inverse-probability-weighting-ipw.html#cb69-74" aria-hidden="true" tabindex="-1"></a>ul  <span class="ot">&lt;-</span> ipw.grf <span class="sc">+</span> (sd.ipw <span class="sc">/</span> <span class="fu">sqrt</span>(<span class="fu">length</span>(<span class="fu">unlist</span>(score)))) <span class="sc">*</span> <span class="fu">qnorm</span>(<span class="dv">1</span> <span class="sc">-</span> alpha<span class="sc">/</span><span class="dv">2</span>)</span>
<span id="cb69-75"><a href="inverse-probability-weighting-ipw.html#cb69-75" aria-hidden="true" tabindex="-1"></a>ll_oracle  <span class="ot">&lt;-</span> ipw.oracle <span class="sc">-</span> (sd.oracle <span class="sc">/</span> <span class="fu">sqrt</span>(<span class="fu">length</span>(score_oracle))) <span class="sc">*</span> <span class="fu">qnorm</span>(<span class="dv">1</span> <span class="sc">-</span> alpha<span class="sc">/</span><span class="dv">2</span>)</span>
<span id="cb69-76"><a href="inverse-probability-weighting-ipw.html#cb69-76" aria-hidden="true" tabindex="-1"></a>ul_oracle  <span class="ot">&lt;-</span> ipw.oracle <span class="sc">+</span> (sd.oracle <span class="sc">/</span> <span class="fu">sqrt</span>(<span class="fu">length</span>(score_oracle))) <span class="sc">*</span> <span class="fu">qnorm</span>(<span class="dv">1</span> <span class="sc">-</span> alpha<span class="sc">/</span><span class="dv">2</span>)</span>
<span id="cb69-77"><a href="inverse-probability-weighting-ipw.html#cb69-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-78"><a href="inverse-probability-weighting-ipw.html#cb69-78" aria-hidden="true" tabindex="-1"></a>result.ipw  <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;IPW estimate&quot;</span> <span class="ot">=</span> <span class="fu">round</span>(ipw.grf, <span class="dv">3</span>), <span class="st">&quot;se&quot;</span> <span class="ot">=</span> <span class="fu">round</span>(sd.ipw <span class="sc">/</span> (<span class="fu">sqrt</span>(<span class="fu">length</span>(W))), <span class="dv">3</span>),</span>
<span id="cb69-79"><a href="inverse-probability-weighting-ipw.html#cb69-79" aria-hidden="true" tabindex="-1"></a>                 <span class="st">&quot;lower bound&quot;</span> <span class="ot">=</span> <span class="fu">round</span>(ll, <span class="dv">3</span>), <span class="st">&quot;upper bound&quot;</span> <span class="ot">=</span> <span class="fu">round</span>(ul, <span class="dv">3</span>))</span>
<span id="cb69-80"><a href="inverse-probability-weighting-ipw.html#cb69-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-81"><a href="inverse-probability-weighting-ipw.html#cb69-81" aria-hidden="true" tabindex="-1"></a>result.oracle.ipw  <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;IPW Oracle estimate&quot;</span> <span class="ot">=</span> <span class="fu">round</span>(ipw.oracle, <span class="dv">3</span>), <span class="st">&quot;se&quot;</span> <span class="ot">=</span> <span class="fu">round</span>(sd.oracle <span class="sc">/</span> (<span class="fu">sqrt</span>(<span class="fu">length</span>(W))), <span class="dv">3</span>),</span>
<span id="cb69-82"><a href="inverse-probability-weighting-ipw.html#cb69-82" aria-hidden="true" tabindex="-1"></a>                 <span class="st">&quot;lower bound&quot;</span> <span class="ot">=</span> <span class="fu">round</span>(ll_oracle, <span class="dv">3</span>), <span class="st">&quot;upper bound&quot;</span> <span class="ot">=</span> <span class="fu">round</span>(ul_oracle, <span class="dv">3</span>))                 </span>
<span id="cb69-83"><a href="inverse-probability-weighting-ipw.html#cb69-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-84"><a href="inverse-probability-weighting-ipw.html#cb69-84" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(result.ipw)</span></code></pre></div>
<pre><code>## IPW estimate           se  lower bound  upper bound 
##       15.508        3.092        9.448       21.568</code></pre>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb71-1"><a href="inverse-probability-weighting-ipw.html#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(result.oracle.ipw)</span></code></pre></div>
<pre><code>## IPW Oracle estimate                  se         lower bound         upper bound 
##              16.496               3.165              10.294              22.699</code></pre>
<p>What? Despite having true propensity score, the Oracle IPW underperforms in accuracy compared to the IPW estimate with unknown propensity score. Why is it so?</p>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="propensity-score-stratification.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="comparing-ipw-with-aggregated-estimate.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="assets/gitbook-2.6.7/js/app.min.js"></script>
<script src="assets/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="assets/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="assets/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="assets/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="assets/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="assets/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="assets/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
},
"toolbar": {
"position": "static"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
