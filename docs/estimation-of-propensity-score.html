<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>3.3 Estimation of propensity score | IPW and AIPW</title>
  <meta name="description" content="3.3 Estimation of propensity score | IPW and AIPW" />
  <meta name="generator" content="bookdown 0.40 and GitBook 2.6.7" />

  <meta property="og:title" content="3.3 Estimation of propensity score | IPW and AIPW" />
  <meta property="og:type" content="book" />
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="3.3 Estimation of propensity score | IPW and AIPW" />
  
  
  

<meta name="author" content="Vinish Shrestha" />


<meta name="date" content="2024-07-09" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="propensity-score.html"/>
<link rel="next" href="using-cross-fitting-to-predict-propensity-score.html"/>
<script src="assets/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="assets/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<script src="assets/accessible-code-block-0.0.1/empty-anchor.js"></script>
<link href="assets/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="assets/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="assets/anchor-sections-1.1.0/anchor-sections.js"></script>
<script src="assets/kePrint-0.0.1/kePrint.js"></script>
<link href="assets/lightable-0.0.1/lightable.css" rel="stylesheet" />
<link href="assets/bsTable-3.3.7/bootstrapTable.min.css" rel="stylesheet" />
<script src="assets/bsTable-3.3.7/bootstrapTable.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Work in Progress</a></li>
<li class="chapter" data-level="2" data-path="causal-inference-an-introduction.html"><a href="causal-inference-an-introduction.html"><i class="fa fa-check"></i><b>2</b> Causal Inference: An Introduction</a>
<ul>
<li class="chapter" data-level="2.1" data-path="potential-outcome-framework-neyman-rubin-causal-model.html"><a href="potential-outcome-framework-neyman-rubin-causal-model.html"><i class="fa fa-check"></i><b>2.1</b> Potential Outcome Framework: Neyman-Rubin Causal Model</a></li>
<li class="chapter" data-level="2.2" data-path="average-treatment-effect-ate.html"><a href="average-treatment-effect-ate.html"><i class="fa fa-check"></i><b>2.2</b> Average treatment effect (ATE)</a></li>
<li class="chapter" data-level="2.3" data-path="rct.html"><a href="rct.html"><i class="fa fa-check"></i><b>2.3</b> RCT</a></li>
<li class="chapter" data-level="2.4" data-path="average-treatment-effect-on-the-treated-att.html"><a href="average-treatment-effect-on-the-treated-att.html"><i class="fa fa-check"></i><b>2.4</b> Average treatment effect on the treated (ATT)</a></li>
<li class="chapter" data-level="2.5" data-path="an-estimation-example.html"><a href="an-estimation-example.html"><i class="fa fa-check"></i><b>2.5</b> An estimation example</a></li>
<li class="chapter" data-level="2.6" data-path="unconfoundedness-assumption.html"><a href="unconfoundedness-assumption.html"><i class="fa fa-check"></i><b>2.6</b> Unconfoundedness assumption</a></li>
<li class="chapter" data-level="2.7" data-path="discussion.html"><a href="discussion.html"><i class="fa fa-check"></i><b>2.7</b> Discussion</a></li>
<li class="chapter" data-level="2.8" data-path="reference.html"><a href="reference.html"><i class="fa fa-check"></i><b>2.8</b> Reference</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="ipw-and-aipw.html"><a href="ipw-and-aipw.html"><i class="fa fa-check"></i><b>3</b> IPW and AIPW</a>
<ul>
<li class="chapter" data-level="3.1" data-path="a-simple-example.html"><a href="a-simple-example.html"><i class="fa fa-check"></i><b>3.1</b> A simple example</a></li>
<li class="chapter" data-level="3.2" data-path="propensity-score.html"><a href="propensity-score.html"><i class="fa fa-check"></i><b>3.2</b> Propensity score</a></li>
<li class="chapter" data-level="3.3" data-path="estimation-of-propensity-score.html"><a href="estimation-of-propensity-score.html"><i class="fa fa-check"></i><b>3.3</b> Estimation of propensity score</a></li>
<li class="chapter" data-level="3.4" data-path="using-cross-fitting-to-predict-propensity-score.html"><a href="using-cross-fitting-to-predict-propensity-score.html"><i class="fa fa-check"></i><b>3.4</b> Using cross-fitting to predict propensity score</a></li>
<li class="chapter" data-level="3.5" data-path="propensity-score-stratification.html"><a href="propensity-score-stratification.html"><i class="fa fa-check"></i><b>3.5</b> Propensity score stratification</a></li>
<li class="chapter" data-level="3.6" data-path="inverse-probability-weighting-and-estimation.html"><a href="inverse-probability-weighting-and-estimation.html"><i class="fa fa-check"></i><b>3.6</b> Inverse Probability Weighting and Estimation</a></li>
<li class="chapter" data-level="3.7" data-path="aipw-and-estimation.html"><a href="aipw-and-estimation.html"><i class="fa fa-check"></i><b>3.7</b> AIPW and Estimation</a></li>
<li class="chapter" data-level="3.8" data-path="assessing-balance.html"><a href="assessing-balance.html"><i class="fa fa-check"></i><b>3.8</b> Assessing Balance</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="causal-forest.html"><a href="causal-forest.html"><i class="fa fa-check"></i><b>4</b> Causal Forest</a>
<ul>
<li class="chapter" data-level="4.1" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>4.1</b> Introduction</a></li>
<li class="chapter" data-level="4.2" data-path="summary-of-grf.html"><a href="summary-of-grf.html"><i class="fa fa-check"></i><b>4.2</b> Summary of GRF</a></li>
<li class="chapter" data-level="4.3" data-path="motivation-for-causal-forests.html"><a href="motivation-for-causal-forests.html"><i class="fa fa-check"></i><b>4.3</b> Motivation for Causal Forests</a></li>
<li class="chapter" data-level="4.4" data-path="causal-forest-1.html"><a href="causal-forest-1.html"><i class="fa fa-check"></i><b>4.4</b> Causal Forest</a></li>
<li class="chapter" data-level="4.5" data-path="an-example-of-causal-forest.html"><a href="an-example-of-causal-forest.html"><i class="fa fa-check"></i><b>4.5</b> An example of causal forest</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="heterogeneous-treatment-effects.html"><a href="heterogeneous-treatment-effects.html"><i class="fa fa-check"></i><b>5</b> Heterogeneous Treatment Effects</a>
<ul>
<li class="chapter" data-level="5.1" data-path="some-ways-to-estimate-cate.html"><a href="some-ways-to-estimate-cate.html"><i class="fa fa-check"></i><b>5.1</b> Some ways to estimate CATE</a></li>
<li class="chapter" data-level="5.2" data-path="estimation.html"><a href="estimation.html"><i class="fa fa-check"></i><b>5.2</b> Estimation</a></li>
<li class="chapter" data-level="5.3" data-path="some-remarks-and-questions.html"><a href="some-remarks-and-questions.html"><i class="fa fa-check"></i><b>5.3</b> Some Remarks and Questions</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">IPW and AIPW</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="estimation-of-propensity-score" class="section level2 hasAnchor" number="3.3">
<h2><span class="header-section-number">3.3</span> Estimation of propensity score<a href="estimation-of-propensity-score.html#estimation-of-propensity-score" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ul>
<li><p>Propensity scores can be estimated using various statistical or machine learning models.</p></li>
<li><p>We will first estimate propensity score using a logistic regression model, where the treatment assignment <span class="math inline">\(W\)</span> is regressed on the covariates <span class="math inline">\(X\)</span>.</p></li>
<li><p>Next, we will estimate propensity score using random forest model built within the GRF framework in Athey et al. </p></li>
</ul>
<p><strong>Logistic Regression</strong></p>
<p>Using a linear regression framework to predict probabilities when the outcome is binary <span class="math inline">\(\{0, \; 1\}\)</span> falls short since the predicted values can go beyond 0 and 1. Many models contain
values within the range of 0 and 1, which can be used to model a binary response. The logistic regression uses a logistic function given as:</p>
<p><span class="math display" id="eq:logit">\[\begin{equation}
p(X) = \frac{e^{\beta_0 + \beta_1 X_1 + \beta_2 X_2 + .... \beta_p X_p}}{1 + e^{\beta_0 + \beta_1 X_1 + \beta_2 X_2 + .... \beta_p X_p}} \tag{3.6}  
\end{equation}\]</span></p>
<p>It is easy to see that <span class="math inline">\(lim_{a \rightarrow - \inf}[\frac{e^a}{1+e^a}] = 0\)</span> and <span class="math inline">\(lim_{a \rightarrow \inf}[\frac{e^a}{1+e^a}] = 1\)</span>. Equation @ref{eq:logit} can be transformed using the <em>logit transformation</em> given as:</p>
<p><span class="math display">\[\begin{equation}
g(X) = ln[\frac{p(X)}{1-p(X)}] = \beta_0 + \beta_1 X_1 + \beta_2 X_2 + .... \beta_p X_p
\end{equation}\]</span></p>
<p>We want to fit a logistic regression in order to predict the probability. For now, we will use simulated data.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="estimation-of-propensity-score.html#cb3-1" aria-hidden="true"></a><span class="co"># helper packages</span></span>
<span id="cb3-2"><a href="estimation-of-propensity-score.html#cb3-2" aria-hidden="true"></a><span class="kw">library</span>(dplyr)  <span class="co"># data wrangling </span></span>
<span id="cb3-3"><a href="estimation-of-propensity-score.html#cb3-3" aria-hidden="true"></a><span class="kw">library</span>(ggplot2) <span class="co"># plots</span></span>
<span id="cb3-4"><a href="estimation-of-propensity-score.html#cb3-4" aria-hidden="true"></a><span class="kw">library</span>(rsample) <span class="co"># data splitting</span></span>
<span id="cb3-5"><a href="estimation-of-propensity-score.html#cb3-5" aria-hidden="true"></a><span class="kw">library</span>(tidyr) <span class="co"># for reshaping, pivot_wider</span></span>
<span id="cb3-6"><a href="estimation-of-propensity-score.html#cb3-6" aria-hidden="true"></a></span>
<span id="cb3-7"><a href="estimation-of-propensity-score.html#cb3-7" aria-hidden="true"></a><span class="co"># Modeling package </span></span>
<span id="cb3-8"><a href="estimation-of-propensity-score.html#cb3-8" aria-hidden="true"></a><span class="kw">library</span>(caret) <span class="co"># for logistic regression modeling </span></span>
<span id="cb3-9"><a href="estimation-of-propensity-score.html#cb3-9" aria-hidden="true"></a></span>
<span id="cb3-10"><a href="estimation-of-propensity-score.html#cb3-10" aria-hidden="true"></a><span class="co"># Model interpretability </span></span>
<span id="cb3-11"><a href="estimation-of-propensity-score.html#cb3-11" aria-hidden="true"></a><span class="kw">library</span>(vip)</span>
<span id="cb3-12"><a href="estimation-of-propensity-score.html#cb3-12" aria-hidden="true"></a></span>
<span id="cb3-13"><a href="estimation-of-propensity-score.html#cb3-13" aria-hidden="true"></a></span>
<span id="cb3-14"><a href="estimation-of-propensity-score.html#cb3-14" aria-hidden="true"></a><span class="kw">set.seed</span>(<span class="dv">194</span>) <span class="co"># for replicability</span></span>
<span id="cb3-15"><a href="estimation-of-propensity-score.html#cb3-15" aria-hidden="true"></a></span>
<span id="cb3-16"><a href="estimation-of-propensity-score.html#cb3-16" aria-hidden="true"></a><span class="co"># Generate simulated Data </span></span>
<span id="cb3-17"><a href="estimation-of-propensity-score.html#cb3-17" aria-hidden="true"></a></span>
<span id="cb3-18"><a href="estimation-of-propensity-score.html#cb3-18" aria-hidden="true"></a>n &lt;-<span class="st"> </span><span class="dv">2000</span> <span class="co"># number of obsevations</span></span>
<span id="cb3-19"><a href="estimation-of-propensity-score.html#cb3-19" aria-hidden="true"></a>p &lt;-<span class="st"> </span><span class="dv">10</span> <span class="co"># number of covariates</span></span>
<span id="cb3-20"><a href="estimation-of-propensity-score.html#cb3-20" aria-hidden="true"></a>X &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">rnorm</span>(n <span class="op">*</span><span class="st"> </span>p), n, p) <span class="co"># data matrix</span></span>
<span id="cb3-21"><a href="estimation-of-propensity-score.html#cb3-21" aria-hidden="true"></a>true_effect  &lt;-<span class="st"> </span><span class="fl">2.56</span></span>
<span id="cb3-22"><a href="estimation-of-propensity-score.html#cb3-22" aria-hidden="true"></a></span>
<span id="cb3-23"><a href="estimation-of-propensity-score.html#cb3-23" aria-hidden="true"></a>W &lt;-<span class="st"> </span><span class="kw">rbinom</span>(n, <span class="dv">1</span>, <span class="fl">0.1</span> <span class="op">+</span><span class="st"> </span><span class="fl">0.4</span> <span class="op">*</span><span class="st"> </span>(X[, <span class="dv">1</span>] <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">+</span><span class="st"> </span><span class="fl">0.2</span> <span class="op">*</span><span class="st"> </span>(X[, <span class="dv">2</span>] <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>))</span>
<span id="cb3-24"><a href="estimation-of-propensity-score.html#cb3-24" aria-hidden="true"></a>prob  &lt;-<span class="st"> </span><span class="fl">0.1</span> <span class="op">+</span><span class="st"> </span><span class="fl">0.4</span> <span class="op">*</span><span class="st"> </span>(X[, <span class="dv">1</span>] <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">+</span><span class="st"> </span><span class="fl">0.2</span> <span class="op">*</span><span class="st"> </span>(X[, <span class="dv">2</span>] <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>)  <span class="co"># oracle propensity score</span></span>
<span id="cb3-25"><a href="estimation-of-propensity-score.html#cb3-25" aria-hidden="true"></a></span>
<span id="cb3-26"><a href="estimation-of-propensity-score.html#cb3-26" aria-hidden="true"></a>Y &lt;-<span class="st"> </span>true_effect <span class="op">*</span><span class="st"> </span>W <span class="op">+</span><span class="st"> </span>X[, <span class="dv">2</span>] <span class="op">+</span><span class="st"> </span><span class="kw">pmax</span>(X[, <span class="dv">1</span>], <span class="dv">0</span>) <span class="op">+</span><span class="st"> </span><span class="kw">rnorm</span>(n)</span>
<span id="cb3-27"><a href="estimation-of-propensity-score.html#cb3-27" aria-hidden="true"></a><span class="co">#plot(X[, 1], X[, 2], col = as.factor(W))</span></span>
<span id="cb3-28"><a href="estimation-of-propensity-score.html#cb3-28" aria-hidden="true"></a></span>
<span id="cb3-29"><a href="estimation-of-propensity-score.html#cb3-29" aria-hidden="true"></a>dat  &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="kw">cbind</span>(W, Y, X))</span>
<span id="cb3-30"><a href="estimation-of-propensity-score.html#cb3-30" aria-hidden="true"></a><span class="kw">colnames</span>(dat)  &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;W&quot;</span>, <span class="st">&quot;Y&quot;</span>, <span class="kw">paste0</span>(<span class="st">&quot;X&quot;</span>, <span class="kw">seq</span>(<span class="dv">1</span>, <span class="dv">10</span>))) </span>
<span id="cb3-31"><a href="estimation-of-propensity-score.html#cb3-31" aria-hidden="true"></a>dat  &lt;-<span class="st"> </span>dat  <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb3-32"><a href="estimation-of-propensity-score.html#cb3-32" aria-hidden="true"></a><span class="st">        </span><span class="kw">mutate</span>(<span class="dt">W =</span> <span class="kw">as.factor</span>(W))</span>
<span id="cb3-33"><a href="estimation-of-propensity-score.html#cb3-33" aria-hidden="true"></a></span>
<span id="cb3-34"><a href="estimation-of-propensity-score.html#cb3-34" aria-hidden="true"></a><span class="co"># create 70% training and 30% test data </span></span>
<span id="cb3-35"><a href="estimation-of-propensity-score.html#cb3-35" aria-hidden="true"></a>churn_split  &lt;-<span class="st"> </span><span class="kw">initial_split</span>(dat, <span class="dt">prop =</span> <span class="fl">0.7</span>)</span>
<span id="cb3-36"><a href="estimation-of-propensity-score.html#cb3-36" aria-hidden="true"></a>dat_train  &lt;-<span class="st"> </span><span class="kw">training</span>(churn_split)</span>
<span id="cb3-37"><a href="estimation-of-propensity-score.html#cb3-37" aria-hidden="true"></a>dat_test  &lt;-<span class="st"> </span><span class="kw">testing</span>(churn_split)</span>
<span id="cb3-38"><a href="estimation-of-propensity-score.html#cb3-38" aria-hidden="true"></a></span>
<span id="cb3-39"><a href="estimation-of-propensity-score.html#cb3-39" aria-hidden="true"></a><span class="co"># dimension of training and testing data</span></span>
<span id="cb3-40"><a href="estimation-of-propensity-score.html#cb3-40" aria-hidden="true"></a><span class="kw">print</span>(<span class="kw">dim</span>(dat_train))</span></code></pre></div>
<pre><code>## [1] 1400   12</code></pre>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="estimation-of-propensity-score.html#cb5-1" aria-hidden="true"></a><span class="kw">print</span>(<span class="kw">dim</span>(dat_test))</span></code></pre></div>
<pre><code>## [1] 600  12</code></pre>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="estimation-of-propensity-score.html#cb7-1" aria-hidden="true"></a><span class="co"># let&#39;s compare two different models</span></span>
<span id="cb7-2"><a href="estimation-of-propensity-score.html#cb7-2" aria-hidden="true"></a></span>
<span id="cb7-3"><a href="estimation-of-propensity-score.html#cb7-3" aria-hidden="true"></a><span class="co"># using X1 as the predictor</span></span>
<span id="cb7-4"><a href="estimation-of-propensity-score.html#cb7-4" aria-hidden="true"></a>cv_model1  &lt;-<span class="st"> </span><span class="kw">train</span>(</span>
<span id="cb7-5"><a href="estimation-of-propensity-score.html#cb7-5" aria-hidden="true"></a>     W <span class="op">~</span><span class="st"> </span>X1 <span class="op">+</span><span class="st"> </span>X2 <span class="op">+</span><span class="st"> </span>X3 <span class="op">+</span><span class="st"> </span>X4, </span>
<span id="cb7-6"><a href="estimation-of-propensity-score.html#cb7-6" aria-hidden="true"></a>    <span class="dt">data =</span> dat_train, </span>
<span id="cb7-7"><a href="estimation-of-propensity-score.html#cb7-7" aria-hidden="true"></a>    <span class="dt">method =</span> <span class="st">&quot;glm&quot;</span>, </span>
<span id="cb7-8"><a href="estimation-of-propensity-score.html#cb7-8" aria-hidden="true"></a>    <span class="dt">family =</span> <span class="st">&quot;binomial&quot;</span>, </span>
<span id="cb7-9"><a href="estimation-of-propensity-score.html#cb7-9" aria-hidden="true"></a>    <span class="dt">trControl =</span> <span class="kw">trainControl</span>(<span class="dt">method =</span> <span class="st">&quot;cv&quot;</span>, <span class="dt">number =</span> <span class="dv">10</span>)</span>
<span id="cb7-10"><a href="estimation-of-propensity-score.html#cb7-10" aria-hidden="true"></a>)</span>
<span id="cb7-11"><a href="estimation-of-propensity-score.html#cb7-11" aria-hidden="true"></a></span>
<span id="cb7-12"><a href="estimation-of-propensity-score.html#cb7-12" aria-hidden="true"></a><span class="co"># misses out on X1</span></span>
<span id="cb7-13"><a href="estimation-of-propensity-score.html#cb7-13" aria-hidden="true"></a>cv_model2  &lt;-<span class="st"> </span><span class="kw">train</span>(</span>
<span id="cb7-14"><a href="estimation-of-propensity-score.html#cb7-14" aria-hidden="true"></a>     W <span class="op">~</span><span class="st"> </span>X2 <span class="op">+</span><span class="st"> </span>X3 <span class="op">+</span><span class="st"> </span>X4, </span>
<span id="cb7-15"><a href="estimation-of-propensity-score.html#cb7-15" aria-hidden="true"></a>    <span class="dt">data =</span> dat_train, </span>
<span id="cb7-16"><a href="estimation-of-propensity-score.html#cb7-16" aria-hidden="true"></a>    <span class="dt">method =</span> <span class="st">&quot;glm&quot;</span>, </span>
<span id="cb7-17"><a href="estimation-of-propensity-score.html#cb7-17" aria-hidden="true"></a>    <span class="dt">family =</span> <span class="st">&quot;binomial&quot;</span>, </span>
<span id="cb7-18"><a href="estimation-of-propensity-score.html#cb7-18" aria-hidden="true"></a>    <span class="dt">trControl =</span> <span class="kw">trainControl</span>(<span class="dt">method =</span> <span class="st">&quot;cv&quot;</span>, <span class="dt">number =</span> <span class="dv">10</span>)</span>
<span id="cb7-19"><a href="estimation-of-propensity-score.html#cb7-19" aria-hidden="true"></a>)</span>
<span id="cb7-20"><a href="estimation-of-propensity-score.html#cb7-20" aria-hidden="true"></a></span>
<span id="cb7-21"><a href="estimation-of-propensity-score.html#cb7-21" aria-hidden="true"></a></span>
<span id="cb7-22"><a href="estimation-of-propensity-score.html#cb7-22" aria-hidden="true"></a><span class="co"># print the sample performance measures </span></span>
<span id="cb7-23"><a href="estimation-of-propensity-score.html#cb7-23" aria-hidden="true"></a></span>
<span id="cb7-24"><a href="estimation-of-propensity-score.html#cb7-24" aria-hidden="true"></a>sum_performance  &lt;-<span class="st">  </span><span class="kw">summary</span>(</span>
<span id="cb7-25"><a href="estimation-of-propensity-score.html#cb7-25" aria-hidden="true"></a>    <span class="kw">resamples</span>(</span>
<span id="cb7-26"><a href="estimation-of-propensity-score.html#cb7-26" aria-hidden="true"></a>        <span class="kw">list</span>(</span>
<span id="cb7-27"><a href="estimation-of-propensity-score.html#cb7-27" aria-hidden="true"></a>            model1  &lt;-<span class="st"> </span>cv_model1, </span>
<span id="cb7-28"><a href="estimation-of-propensity-score.html#cb7-28" aria-hidden="true"></a>            model2  &lt;-<span class="st"> </span>cv_model2</span>
<span id="cb7-29"><a href="estimation-of-propensity-score.html#cb7-29" aria-hidden="true"></a>        )</span>
<span id="cb7-30"><a href="estimation-of-propensity-score.html#cb7-30" aria-hidden="true"></a>    )</span>
<span id="cb7-31"><a href="estimation-of-propensity-score.html#cb7-31" aria-hidden="true"></a>)</span>
<span id="cb7-32"><a href="estimation-of-propensity-score.html#cb7-32" aria-hidden="true"></a></span>
<span id="cb7-33"><a href="estimation-of-propensity-score.html#cb7-33" aria-hidden="true"></a>sum_performance<span class="op">$</span>statistics<span class="op">$</span>Accuracy</span></code></pre></div>
<pre><code>##             Min.   1st Qu.    Median      Mean   3rd Qu.      Max. NA&#39;s
## Model1 0.6043165 0.6446429 0.6678571 0.6706292 0.6964286 0.7285714    0
## Model2 0.5642857 0.5785714 0.5892392 0.5935621 0.6160714 0.6285714    0</code></pre>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="estimation-of-propensity-score.html#cb9-1" aria-hidden="true"></a><span class="co"># use the confusion matrix </span></span>
<span id="cb9-2"><a href="estimation-of-propensity-score.html#cb9-2" aria-hidden="true"></a></span>
<span id="cb9-3"><a href="estimation-of-propensity-score.html#cb9-3" aria-hidden="true"></a><span class="co"># predict class </span></span>
<span id="cb9-4"><a href="estimation-of-propensity-score.html#cb9-4" aria-hidden="true"></a></span>
<span id="cb9-5"><a href="estimation-of-propensity-score.html#cb9-5" aria-hidden="true"></a>threshold  &lt;-<span class="st"> </span><span class="fl">0.5</span></span>
<span id="cb9-6"><a href="estimation-of-propensity-score.html#cb9-6" aria-hidden="true"></a>pred_prob  &lt;-<span class="st"> </span><span class="kw">predict</span>(cv_model1, dat_train, <span class="dt">type =</span> <span class="st">&quot;prob&quot;</span>)</span>
<span id="cb9-7"><a href="estimation-of-propensity-score.html#cb9-7" aria-hidden="true"></a>pred_class_manual  &lt;-<span class="st">  </span><span class="kw">rep</span>(<span class="dv">0</span>, <span class="dv">1400</span>)</span>
<span id="cb9-8"><a href="estimation-of-propensity-score.html#cb9-8" aria-hidden="true"></a>pred_class_manual[pred_prob[, <span class="dv">2</span>] <span class="op">&gt;=</span><span class="st"> </span><span class="fl">0.5</span>]  &lt;-<span class="st"> </span><span class="dv">1</span></span>
<span id="cb9-9"><a href="estimation-of-propensity-score.html#cb9-9" aria-hidden="true"></a></span>
<span id="cb9-10"><a href="estimation-of-propensity-score.html#cb9-10" aria-hidden="true"></a>pred_class  &lt;-<span class="st"> </span><span class="kw">predict</span>(cv_model1, dat_train)</span>
<span id="cb9-11"><a href="estimation-of-propensity-score.html#cb9-11" aria-hidden="true"></a></span>
<span id="cb9-12"><a href="estimation-of-propensity-score.html#cb9-12" aria-hidden="true"></a><span class="co"># print the confusion matrix </span></span>
<span id="cb9-13"><a href="estimation-of-propensity-score.html#cb9-13" aria-hidden="true"></a><span class="kw">confusionMatrix</span>(</span>
<span id="cb9-14"><a href="estimation-of-propensity-score.html#cb9-14" aria-hidden="true"></a>    <span class="dt">data =</span> <span class="kw">relevel</span>(pred_class, <span class="dt">ref =</span> <span class="st">&quot;1&quot;</span>), <span class="co"># predictions</span></span>
<span id="cb9-15"><a href="estimation-of-propensity-score.html#cb9-15" aria-hidden="true"></a>    <span class="dt">reference =</span> <span class="kw">relevel</span>(dat_train<span class="op">$</span>W, <span class="dt">ref =</span> <span class="st">&quot;1&quot;</span>) <span class="co"># reference or the true value</span></span>
<span id="cb9-16"><a href="estimation-of-propensity-score.html#cb9-16" aria-hidden="true"></a>)</span></code></pre></div>
<pre><code>## Confusion Matrix and Statistics
## 
##           Reference
## Prediction   1   0
##          1 270 151
##          0 299 680
##                                          
##                Accuracy : 0.6786         
##                  95% CI : (0.6534, 0.703)
##     No Information Rate : 0.5936         
##     P-Value [Acc &gt; NIR] : 3.164e-11      
##                                          
##                   Kappa : 0.3053         
##                                          
##  Mcnemar&#39;s Test P-Value : 4.219e-12      
##                                          
##             Sensitivity : 0.4745         
##             Specificity : 0.8183         
##          Pos Pred Value : 0.6413         
##          Neg Pred Value : 0.6946         
##              Prevalence : 0.4064         
##          Detection Rate : 0.1929         
##    Detection Prevalence : 0.3007         
##       Balanced Accuracy : 0.6464         
##                                          
##        &#39;Positive&#39; Class : 1              
## </code></pre>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="estimation-of-propensity-score.html#cb11-1" aria-hidden="true"></a><span class="co"># if predict all yes still get an accuracy of 0.5936</span></span>
<span id="cb11-2"><a href="estimation-of-propensity-score.html#cb11-2" aria-hidden="true"></a><span class="kw">table</span>(dat_train<span class="op">$</span>W)  <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">prop.table</span>()</span></code></pre></div>
<pre><code>## 
##         0         1 
## 0.5935714 0.4064286</code></pre>
<p>Looking at the confusion matrix, the values on the downward diagonal ([1, 1] and [2, 2] in matrix) are correctly idenfified by the model, while the upward diagonal values ([2, 1] and [1, 2]) are incorrectly classified. If all of the observations were assigned the value of 0, the accuracy would still be 0.5936%. This is termed as the <em>no information rate</em>. The model performs quite well in predicting True Negatives (classify as 0, when the value is actually 0). However, it does not perform so well in classifying the True Positives – more than 50% of the positive cases are classified as negative.</p>
<p>Next, two measures of importance are <em>sensitivity</em> and <em>specificity</em>. The sensitivity measure tracks the true positive rate from the model, while the specificity measure tracks the true negative rate.</p>
<ul>
<li><p><span class="math inline">\(sensitivity = \frac{True \; positives}{True \; positives + False \; negatives} = 0.8790\)</span>.</p></li>
<li><p><span class="math inline">\(specificity = \frac{True \; negatives}{True \; negatives \; + \; False \; positives} = \frac{604}{604 + 85} = 0.8766\)</span>.</p></li>
</ul>
<p><strong>How are the observations classified?</strong>
A threshold value is used to transform the raw prediction of probabilities into classification such that <span class="math inline">\(P(Y_{i} &gt; p_{threshold})=1.\)</span> The implicit <span class="math inline">\(p_{threshold}\)</span> used is 0.5. Varying the threshold from 0 to 1, one can calculate the relationship between the False Positive Rate (the prediction is positive when in actual the outcome is negative) and True Positive Rate at each threshold value. If the threshold value <span class="math inline">\((p_{threshold})\)</span> is 1, then all observations are classified as 0, which means that the False Positive Rate is 0 but so is the True Positive Rate. Similarly, if the threshold is 0, then both True and False positive rates are 1. This gives the Receiver Operating Characteristic (ROC).</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="estimation-of-propensity-score.html#cb13-1" aria-hidden="true"></a><span class="kw">library</span>(ROCR)</span>
<span id="cb13-2"><a href="estimation-of-propensity-score.html#cb13-2" aria-hidden="true"></a></span>
<span id="cb13-3"><a href="estimation-of-propensity-score.html#cb13-3" aria-hidden="true"></a><span class="co"># compute probabilities </span></span>
<span id="cb13-4"><a href="estimation-of-propensity-score.html#cb13-4" aria-hidden="true"></a>m1_prob  &lt;-<span class="st"> </span><span class="kw">predict</span>(cv_model1, dat_train, <span class="dt">type =</span> <span class="st">&quot;prob&quot;</span>)[, <span class="dv">2</span>]</span>
<span id="cb13-5"><a href="estimation-of-propensity-score.html#cb13-5" aria-hidden="true"></a>m2_prob  &lt;-<span class="st"> </span><span class="kw">predict</span>(cv_model2, dat_train, <span class="dt">type =</span> <span class="st">&quot;prob&quot;</span>)[, <span class="dv">2</span>]</span>
<span id="cb13-6"><a href="estimation-of-propensity-score.html#cb13-6" aria-hidden="true"></a></span>
<span id="cb13-7"><a href="estimation-of-propensity-score.html#cb13-7" aria-hidden="true"></a><span class="co"># AUC metrics </span></span>
<span id="cb13-8"><a href="estimation-of-propensity-score.html#cb13-8" aria-hidden="true"></a>perf1  &lt;-<span class="st"> </span><span class="kw">prediction</span>(m1_prob, dat_train<span class="op">$</span>W)  <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb13-9"><a href="estimation-of-propensity-score.html#cb13-9" aria-hidden="true"></a><span class="st">            </span><span class="kw">performance</span>(<span class="dt">measure =</span> <span class="st">&quot;tpr&quot;</span>, <span class="dt">x.measure =</span> <span class="st">&quot;fpr&quot;</span>)</span>
<span id="cb13-10"><a href="estimation-of-propensity-score.html#cb13-10" aria-hidden="true"></a></span>
<span id="cb13-11"><a href="estimation-of-propensity-score.html#cb13-11" aria-hidden="true"></a>perf2  &lt;-<span class="st"> </span><span class="kw">prediction</span>(m2_prob, dat_train<span class="op">$</span>W)  <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb13-12"><a href="estimation-of-propensity-score.html#cb13-12" aria-hidden="true"></a><span class="st">            </span><span class="kw">performance</span>(<span class="dt">measure =</span> <span class="st">&quot;tpr&quot;</span>, <span class="dt">x.measure =</span> <span class="st">&quot;fpr&quot;</span>)</span>
<span id="cb13-13"><a href="estimation-of-propensity-score.html#cb13-13" aria-hidden="true"></a></span>
<span id="cb13-14"><a href="estimation-of-propensity-score.html#cb13-14" aria-hidden="true"></a><span class="co"># plot ROC curves</span></span>
<span id="cb13-15"><a href="estimation-of-propensity-score.html#cb13-15" aria-hidden="true"></a><span class="kw">plot</span>(perf1, <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>)</span>
<span id="cb13-16"><a href="estimation-of-propensity-score.html#cb13-16" aria-hidden="true"></a><span class="kw">plot</span>(perf2, <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">col =</span> <span class="st">&quot;green&quot;</span>) </span>
<span id="cb13-17"><a href="estimation-of-propensity-score.html#cb13-17" aria-hidden="true"></a><span class="kw">legend</span>(<span class="fl">0.8</span>, <span class="fl">0.2</span>, <span class="dt">legend =</span> <span class="kw">c</span>(<span class="st">&quot;cv_model1&quot;</span>, <span class="st">&quot;cv_model2&quot;</span>), <span class="dt">lty =</span> <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>),</span>
<span id="cb13-18"><a href="estimation-of-propensity-score.html#cb13-18" aria-hidden="true"></a>            <span class="dt">col =</span> <span class="kw">c</span>(<span class="st">&quot;red&quot;</span>, <span class="st">&quot;green&quot;</span>), <span class="dt">cex =</span> <span class="fl">0.6</span>)</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:unnamed-chunk-4"></span>
<img src="book_files/figure-html/unnamed-chunk-4-1.png" alt="ROC" width="672" />
<p class="caption">
Figure 3.1: ROC
</p>
</div>
<p>The figure above plots the ROC for two models that we tested using cross-validation. The cv_model2 produces a diagonal line, which means that this model is as good as a random guess. Next, cv_model1 performs a whole lot better since a large gains in True positive rate can be achieved with a relatively small increase in False positive rate at the start. The ROC curve pertaining to cv_model1 helps pick a threshold to balance the sensitivity (True Positive Rate) and specificity (1 - False Positive Rate).</p>
<p>The histogram of the estimated propensity scores using the logistic regression is as:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="estimation-of-propensity-score.html#cb14-1" aria-hidden="true"></a><span class="kw">hist</span>(pred_prob[, <span class="dv">2</span>], <span class="dt">main =</span> <span class="st">&quot;Histogram of P(W=1|X)</span></span>
<span id="cb14-2"><a href="estimation-of-propensity-score.html#cb14-2" aria-hidden="true"></a><span class="st">      </span><span class="ch">\n</span><span class="st"> using Logistic Regression&quot;</span>, <span class="dt">xlab =</span> <span class="st">&quot;probabilities&quot;</span>)</span></code></pre></div>
<p><img src="book_files/figure-html/unnamed-chunk-5-1.png" width="672" /></p>
<p>Now, let’s take a look at the confusion matrix using the test data.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="estimation-of-propensity-score.html#cb15-1" aria-hidden="true"></a>pred_class_test  &lt;-<span class="st"> </span><span class="kw">predict</span>(cv_model1, dat_test)</span>
<span id="cb15-2"><a href="estimation-of-propensity-score.html#cb15-2" aria-hidden="true"></a></span>
<span id="cb15-3"><a href="estimation-of-propensity-score.html#cb15-3" aria-hidden="true"></a><span class="co"># print the confusion matrix this time for the test sample </span></span>
<span id="cb15-4"><a href="estimation-of-propensity-score.html#cb15-4" aria-hidden="true"></a><span class="kw">confusionMatrix</span>(</span>
<span id="cb15-5"><a href="estimation-of-propensity-score.html#cb15-5" aria-hidden="true"></a>    <span class="dt">data =</span> <span class="kw">relevel</span>(pred_class_test, <span class="dt">ref =</span> <span class="st">&quot;1&quot;</span>), <span class="co"># classification from the prediction</span></span>
<span id="cb15-6"><a href="estimation-of-propensity-score.html#cb15-6" aria-hidden="true"></a>    <span class="dt">reference =</span> <span class="kw">relevel</span>(dat_test<span class="op">$</span>W, <span class="dt">ref =</span> <span class="st">&quot;1&quot;</span>) <span class="co"># ground truth </span></span>
<span id="cb15-7"><a href="estimation-of-propensity-score.html#cb15-7" aria-hidden="true"></a>)</span></code></pre></div>
<pre><code>## Confusion Matrix and Statistics
## 
##           Reference
## Prediction   1   0
##          1  94  69
##          0 131 306
##                                           
##                Accuracy : 0.6667          
##                  95% CI : (0.6274, 0.7043)
##     No Information Rate : 0.625           
##     P-Value [Acc &gt; NIR] : 0.01882         
##                                           
##                   Kappa : 0.2474          
##                                           
##  Mcnemar&#39;s Test P-Value : 1.608e-05       
##                                           
##             Sensitivity : 0.4178          
##             Specificity : 0.8160          
##          Pos Pred Value : 0.5767          
##          Neg Pred Value : 0.7002          
##              Prevalence : 0.3750          
##          Detection Rate : 0.1567          
##    Detection Prevalence : 0.2717          
##       Balanced Accuracy : 0.6169          
##                                           
##        &#39;Positive&#39; Class : 1               
## </code></pre>
<p>The measures of accuracy, sensitivity, and specificity are similar for both the training and testing sample.</p>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="propensity-score.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="using-cross-fitting-to-predict-propensity-score.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="assets/gitbook-2.6.7/js/app.min.js"></script>
<script src="assets/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="assets/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="assets/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="assets/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="assets/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="assets/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="assets/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
},
"toolbar": {
"position": "static"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
